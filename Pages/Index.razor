@page "/"
@using System.Globalization
@using System.Text.RegularExpressions

<PageTitle>Финансовый Калькулятор</PageTitle>

<h1>Финансовый Калькулятор: Сложение и Вычитание Больших Чисел</h1>

<p>ФИО: Кулич София Петровна</p>
<p>Курс: 4, Группа: 4</p>
<p>Год: 2025</p>

<p>Введите два числа (от -1 000 000 000 000.000000 до +1 000 000 000 000.000000). Выберите операцию.</p>

<div>
    <label>Число 1:</label>
    <input type="text" @bind="num1Str" placeholder="например, 1.0 или 1 000.0" />
</div>

<div>
    <label>Число 2:</label>
    <input type="text" @bind="num2Str" placeholder="например, 2.0 или 2 000.0" />
</div>

<div>
    <label>Метод округления для результата:</label>
    <select @bind="roundingMethod">
        <option value="Mathematical">Математическое (половина вверх)</option>
        <option value="Banking">Банковское (половина к четному)</option>
    </select>
</div>

<div>
    <button @onclick="CalculateSum">Сложение (+)</button>
    <button @onclick="CalculateDifference">Вычитание (-)</button>
    <button @onclick="CalculateMultiplication">Умножение (×)</button>
    <button @onclick="CalculateDivision">Деление (÷)</button>
</div>

@if (!string.IsNullOrEmpty(result))
{
    <p>Результат: @result</p>
}

@if (!string.IsNullOrEmpty(error))
{
    <p style="color: red;">@error</p>
}

@code {
    private string num1Str = "";
    private string num2Str = "";
    private string roundingMethod = "Mathematical";
    private string result = "";
    private string error = "";
    private const decimal MaxRange = 1000000000000M;

    private void CalculateSum()
    {
        PerformCalculation((a, b) => a + b);
    }

    private void CalculateDifference()
    {
        PerformCalculation((a, b) => a - b);
    }

    private void CalculateMultiplication()
    {
        PerformCalculation((a, b) => a * b);
    }

    private void CalculateDivision()
    {
        if (num2Str.Trim() == "0" || num2Str.Trim() == "0.0")
        {
            error = "Ошибка: деление на ноль невозможно.";
            result = "";
            return;
        }
        PerformCalculation((a, b) => a / b);
    }

    private string FormatResult(decimal value)
    {
        // Округление
        MidpointRounding mode = roundingMethod == "Mathematical" ? MidpointRounding.AwayFromZero : MidpointRounding.ToEven;
        value = Math.Round(value, 6, mode);

        // Разделение целой и дробной части
        string[] parts = value.ToString("F6", CultureInfo.InvariantCulture).Split('.');
        string integerPart = parts[0];
        string fractionalPart = parts[1];

        // Форматирование целой части с пробелами
        string formattedInteger = string.Format(CultureInfo.InvariantCulture, "{0:N0}", decimal.Parse(integerPart)).Replace(",", " ");

        // Удаление незначащих нулей в дробной части
        fractionalPart = fractionalPart.TrimEnd('0');
        if (fractionalPart == "") fractionalPart = "0";

        return $"{formattedInteger}.{fractionalPart}";
    }

    private bool IsValidInput(string input)
    {
        if (string.IsNullOrWhiteSpace(input))
            return false;

        // Проверка на недопустимые символы
        if (input.Contains("--") || input.Contains("..") || input.Contains("-.") || input.Contains(".-"))
            return false;

        // Проверка на двойные пробелы
        if (input.Contains("  "))
            return false;

        // Удаление пробелов и замена запятой на точку для проверки
        string cleaned = input.Replace(" ", "").Replace(',', '.');

        // Проверка на корректность числа
        if (!decimal.TryParse(cleaned, NumberStyles.Number, CultureInfo.InvariantCulture, out _))
            return false;

        // Если в строке есть пробелы, проверяем их корректное расположение
        if (input.Contains(' '))
        {
            // Разделяем на целую и дробную часть
            string[] parts = input.Split('.');
            string integerPart = parts[0];

            // Проверяем формат целой части с пробелами
            // Допустимые форматы: "1", "123", "1 234", "12 345", "123 456", "1 234 567" и т.д.
            if (!Regex.IsMatch(integerPart, @"^-?\d{1,3}(?: \d{3})*$"))
                return false;
        }

        return true;
    }

    private void PerformCalculation(Func<decimal, decimal, decimal> operation)
    {
        error = "";
        result = "";

        // Замена запятой на точку для унификации разделителя
        num1Str = num1Str.Replace(',', '.');

        if (!IsValidInput(num1Str))
        {
            error = "Некорректный ввод Числа 1.";
            return;
        }

        num2Str = num2Str.Replace(',', '.');

        if (!IsValidInput(num2Str))
        {
            error = "Некорректный ввод Числа 2.";
            return;
        }

        // Удаляем пробелы для парсинга
        string cleaned1 = num1Str.Replace(" ", "");
        string cleaned2 = num2Str.Replace(" ", "");

        // Парсинг с invariant culture
        if (!decimal.TryParse(cleaned1, NumberStyles.Number, CultureInfo.InvariantCulture, out decimal num1))
        {
            error = "Некорректное Число 1. Введите корректное десятичное число.";
            return;
        }

        if (!decimal.TryParse(cleaned2, NumberStyles.Number, CultureInfo.InvariantCulture, out decimal num2))
        {
            error = "Некорректное Число 2. Введите корректное десятичное число.";
            return;
        }

        // Проверка диапазона входных чисел
        if (Math.Abs(num1) > MaxRange || Math.Abs(num2) > MaxRange)
        {
            error = "Числа превышают допустимый диапазон (±1 000 000 000 000.000000).";
            return;
        }

        decimal calcResult = operation(num1, num2);

        // Проверка переполнения результата
        if (Math.Abs(calcResult) > MaxRange)
        {
            error = "Переполнение: результат превышает допустимый диапазон.";
            return;
        }

        result = FormatResult(calcResult);
    }
}